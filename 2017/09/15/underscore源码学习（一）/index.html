<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="A contented mind is a perpetual feast."><title>underscore源码学习（一） | WaterBlog</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">underscore源码学习（一）</h1><a id="logo" href="/.">WaterBlog</a><p class="description">WaterGayGay的博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/collection/"><i class="fa fa-bookmark"> 收藏</i></a><a href="/history/"><i class="fa fa-book"> 历史</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">underscore源码学习（一）</h1><div class="post-meta">Sep 15, 2017</div><div class="post-content"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近在社区浏览文章的时候，看到了一位大四学长在寻求前端工作中的面经，看完不得不佩服，掌握知识点真是全面，无论是前端后台还是其他，都有涉猎。</p>
<p>在他写的文章中，有这么一句话，大概意思是，<code>没有看过一个库或者框架的源码还敢出来混</code>。然后自己心虚了一下，一直以来，都只是学习使用框架或库，或者在过程中有学习框架的思想，但并不深入。例如，在学习<code>Vue.js</code>中，我曾经去探索过Vue中的双向绑定是如何实现的，通过什么模式，什么API，作者的思想是什么，也曾经实现过简单版的双向绑定。<br><a id="more"></a><br>但是感觉自己在这方面并没有什么提高，尤其在原生JavaScript的学习中，一些不常用的API经常忘，思维也不够好。所以有了学习优秀的库的源码的想法，一方面能够学习作者的思想，提高自己的分析能力，另一方面我觉得如果能好好分析一个库的源码，对自己的提升也是有的。</p>
<p>所以，刚开始，我从源码比较短的<code>underscore.js</code>(包含注释只有1.5k行)开始学习起。</p>
<h3 id="什么是underscore"><a href="#什么是underscore" class="headerlink" title="什么是underscore"></a>什么是underscore</h3><p>Underscore一个JavaScript实用库，提供了一整套函数式编程的实用功能，但是没有扩展任何JavaScript内置对象。它是这个问题的答案：“如果我在一个空白的HTML页面前坐下， 并希望立即开始工作， 我需要什么？“…它弥补了部分jQuery没有实现的功能,同时又是Backbone.js必不可少的部分。——摘自Underscore中文文档</p>
<p>我的学习之路是基于Underscore1.8.3版本开始的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Current version.</span></div><div class="line"> _.VERSION = <span class="string">'1.8.3'</span>;</div></pre></td></tr></table></figure>
<h3 id="作用域包裹"><a href="#作用域包裹" class="headerlink" title="作用域包裹"></a>作用域包裹</h3><p>与其他第三方库一样，underscore最外层是一个立即执行函数(IIFE)，来包裹自己的业务逻辑。一般使用IIFE有如下好处，可以创建一个独立的沙箱似的作用域，避免全局污染，还可以防止其他代码对该函数内部造成影响。(但凡在立即执行函数中声明的函数、变量等，除非是自己想暴露，否则绝无可能在外部获得)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// ...执行逻辑</span></div><div class="line">	</div><div class="line">&#125;.call(<span class="keyword">this</span>))</div></pre></td></tr></table></figure>
<blockquote>
<p>学习的点，当我们要写自己的库或者封装某个功能函数时，可以给自己的库或函数在最外层包裹一个立即执行函数，这样既不会受外部影响，也不会给外部添麻烦。</p>
</blockquote>
<h3 id="对象"><a href="#对象" class="headerlink" title="_对象"></a>_对象</h3><p>underscore有下划线的意思，所以underscore通过一个下划线变量<code>_</code>来标识自身，值得注意的是，<code>_</code>是一个函数对象或者说是一个构造函数，并且支持无new调用的构造的函数，所有API都会挂载在这个对象上，如<code>_.each,_.map</code>等<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> _ = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span>(obj <span class="keyword">instanceof</span> _) <span class="keyword">return</span> obj;</div><div class="line">	<span class="keyword">if</span>(!(<span class="keyword">this</span> <span class="keyword">instanceof</span> _)) <span class="keyword">return</span> <span class="keyword">new</span> _(obj) <span class="comment">//实例化</span></div><div class="line">	<span class="keyword">this</span>._wrapped = obj</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="全局命名空间"><a href="#全局命名空间" class="headerlink" title="全局命名空间"></a>全局命名空间</h3><p>underscore使用<code>root</code>变量保存了全局的<code>this</code>。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> root = <span class="keyword">this</span>;</div></pre></td></tr></table></figure></p>
<p>为了防止其他库对<code>_</code>的冲突或影响，underscore做了如下处理，<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> previousUnderscore = root._</div><div class="line">_.noConflict = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	root._ = perviousUnderscore;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="执行环境判断"><a href="#执行环境判断" class="headerlink" title="执行环境判断"></a>执行环境判断</h3><p>underscore 既能够服务于浏览器，又能够服务于诸如 nodejs 所搭建的服务端。<br>一般，在客户端（浏览器）环境中，<code>_</code>即为<code>window._=_</code>，暴露在全局中。若在node环境中，<code>_</code>将被作为模块导出，并且向后兼容老的API，即require。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> exports !== <span class="string">'undefined'</span>) &#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">module</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="built_in">module</span>.exports) &#123;</div><div class="line">    exports = <span class="built_in">module</span>.exports = _;  </div><div class="line">  &#125;</div><div class="line">  exports._ = _ ;</div><div class="line">&#125; esle &#123;</div><div class="line">  root._ = _;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="缓存局部变量及快速引用"><a href="#缓存局部变量及快速引用" class="headerlink" title="缓存局部变量及快速引用"></a>缓存局部变量及快速引用</h3><p>underscore本身用到了不少ES5的原生方法，在浏览器支持的条件下，underscore率先使用原生的ES5方法。如下代码所示，underscore通过局部变量来保存一些常用到的方法或者属性。<br>这样做有几个好处：</p>
<ul>
<li>便于压缩代码</li>
<li>提高代码性能，减少在原型链中的查找次数</li>
<li>同时也可减少代码量，避免在使用时冗长的书写<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ArrayProto = <span class="built_in">Array</span>.prototype, ObjProto = <span class="built_in">Object</span>.prototype, FuncProto = <span class="built_in">Function</span>.prototype;</div><div class="line"><span class="keyword">var</span></div><div class="line">  push             = ArrayProto.push,</div><div class="line">  slice            = ArrayProto.slice,</div><div class="line">  toString         = ObjProto.toString,</div><div class="line">  hasOwnProperty   = ObjProto.hasOwnProperty;</div><div class="line"><span class="keyword">var</span></div><div class="line">  nativeIsArray      = <span class="built_in">Array</span>.isArray,</div><div class="line">  nativeKeys         = <span class="built_in">Object</span>.keys,</div><div class="line">  nativeBind         = FuncProto.bind,</div><div class="line">  nativeCreate       = <span class="built_in">Object</span>.create;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="undefined处理"><a href="#undefined处理" class="headerlink" title="undefined处理"></a>undefined处理</h3><p>在underscore中，有很多函数都会有一个<code>context</code>函数，也就是当前函数的执行上下文，underscore对其进行了处理，如果没有传入<code>context</code>即<code>context</code>为<code>undefined</code>，则返回原函数。<br>这里判断值为<code>undefined</code>用的是<code>void 0</code>，如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (context === <span class="keyword">void</span> o) <span class="keyword">return</span> func</div></pre></td></tr></table></figure></p>
<p>作为一只涉猎尚浅的小白，查阅<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/void" target="_blank" rel="external">资料</a>之后终于知道这里作者为什么要用<code>void 0</code>来做判断了。</p>
<p>详情可点链接了解，这样做更加安全可靠。<br>在还没看到这个代码时， 如果我要判断一个值是不是<code>undefined</code>，我会这样写<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (context === <span class="literal">undefined</span>) &#123;&#125;</div></pre></td></tr></table></figure></p>
<p>但是，在发现作者的<code>void 0</code>之后，才发现这样写并不可靠，在JavaScript中，我们可以这样写：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">args =&gt; &#123;</div><div class="line">  <span class="keyword">let</span> <span class="literal">undefined</span> = <span class="number">1</span></div><div class="line">  <span class="built_in">console</span>.log(<span class="literal">undefined</span>) <span class="comment">// =&gt; 1</span></div><div class="line">  <span class="keyword">if</span> (args === <span class="literal">undefined</span>) &#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果这样写，<code>undefined</code>就被轻易地修改为了<code>1</code>，所以对于我们之后定义的<code>undefined</code>的理解有歧义。所以，在JavaScript中，把<code>undefined</code>直接解释为“未定义”是有风险的，因为它可能被修改。</p>
<blockquote>
<p>学习：以后判断<code>undefined</code>直接使用<code>void 0</code>, 看起来也优雅一点（滑稽脸）。</p>
</blockquote>
</div><div class="tags"><a href="/tags/JavaScript/">JavaScript</a></div><div class="post-nav"><a href="/2017/08/22/JavaScript-Sorting-Algorithm/" class="next">JavaScript Sorting Algorithm</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=1.0.0"><script src="/js/gitment.browser.js?v=1.0.0"></script><script>var gitment = new Gitment({
  owner: 'k-water',
  repo: 'k-water.github.io',
  oauth: {
    client_id: 'b80d9a577bec58f5cd74',
    client_secret: 'bb14317e485db9a408465da9eac80af12e340ad9',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://waterlin.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/more/"><!--more--></a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/BackEnd/">BackEnd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FontEnd/">FontEnd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Server/">Server</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tool/">Tool</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/CSS/" style="font-size: 15px;">CSS</a> <a href="/tags/jQuery/" style="font-size: 15px;">jQuery</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/blog/" style="font-size: 15px;">blog</a> <a href="/tags/Algorithm/" style="font-size: 15px;">Algorithm</a> <a href="/tags/Data-struct/" style="font-size: 15px;">Data struct</a> <a href="/tags/BFC/" style="font-size: 15px;">BFC</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Sass/" style="font-size: 15px;">Sass</a> <a href="/tags/Browser/" style="font-size: 15px;">Browser</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/HTML5/" style="font-size: 15px;">HTML5</a> <a href="/tags/ES6/" style="font-size: 15px;">ES6</a> <a href="/tags/CSS3/" style="font-size: 15px;">CSS3</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/VSCode/" style="font-size: 15px;">VSCode</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/转载/" style="font-size: 15px;">转载</a> <a href="/tags/服务器/" style="font-size: 15px;">服务器</a> <a href="/tags/IFE/" style="font-size: 15px;">IFE</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/汇编/" style="font-size: 15px;">汇编</a> <a href="/tags/RegExp/" style="font-size: 15px;">RegExp</a> <a href="/tags/Electron/" style="font-size: 15px;">Electron</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/15/underscore源码学习（一）/">underscore源码学习（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/22/JavaScript-Sorting-Algorithm/">JavaScript Sorting Algorithm</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/18/在Vue中使用第三方库/">在Vue中使用第三方库</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/13/基于vue-electron的项目梳理总结/">基于vue-electron的项目梳理总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/01/媒体查询/">媒体查询</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/29/基于Vue-js的音乐播放器（Webapp）/">基于Vue.js的音乐播放器（Webapp）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/20/项目总结/">项目总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/11/常用正则表达式/">常用正则表达式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/30/转载-JavaScript函数声明提升/">JavaScript函数声明提升</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/19/转载-浅析前端工程化/">浅析前端工程化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.lxstart.net/" title="x-cold" target="_blank">x-cold</a><ul></ul><a href="http://www.cnblogs.com/liuweimingcprogram" title="SCAU_L" target="_blank">SCAU_L</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2016-2017 <a href="/." rel="nofollow">WaterBlog.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zIndex="-2" count="50" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script><script type="text/javascript" src="/js/background-canvas.js?v=1.0.0"></script></div></body></html>